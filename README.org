This is a [[https://guix.gnu.org/][Guix]] channel for [[https://nonsmooth.gricad-pages.univ-grenoble-alpes.fr/siconos/index][Siconos]].

See [[https://guix.gnu.org/manual/en/html_node/Channels.html][Guix channels]] for more informations.

* Usage

** Specification without constraints:

#+begin_src scheme :eval no :tangle siconos-now.scm
  (cons
   (channel (name 'guix-siconos)
            (url "https://github.com/siconos/guix-siconos"))
   %default-channels)
#+end_src

** Example with constraints on Siconos channel and Guix channel:

#+begin_src scheme :eval no :tangle siconos-2021-05-03.scm
(list (channel
        (name 'guix-siconos)
        (url "https://github.com/siconos/guix-siconos")
        (commit
          "be544bc07cd256f8e14566e0bfb3d59828ea4f0e"))
      (channel
        (name 'guix)
        (url "https://git.savannah.gnu.org/git/guix.git")
        (commit
          "f0eb053dac8273416ab24541b85617d79dbae134")))
#+end_src

* Specifications

** Download

Some specifications are available in the channel branch of this repository.
They are named with this convention:

 - without constraints, the channels file is named =siconos-now.scm=
 - with constraints on commits with the same date for Siconos channel
   and Guix channel: =siconos-<iso 8601 date of commits>.scm=
 - with different dates for Siconos channel and Guix channel:
   =siconos-<iso 8601 date of siconos commits>-<iso 8601 date of Guix commits>.scm=


#+begin_src sh :dir /tmp :results value silent
  wget -q -N https://raw.githubusercontent.com/siconos/guix-siconos/channels/siconos-now.scm
#+end_src

#+begin_src sh :dir /tmp :results value silent
  wget -q -N https://raw.githubusercontent.com/siconos/guix-siconos/channels/siconos-2021-05-05.scm
#+end_src


** How to form a reproductible specification:

#+name: fix-channels-with-wget
#+begin_src sh :dir /tmp :results raw :compile :results output silent
  wget -q -N https://raw.githubusercontent.com/siconos/guix-siconos/channels/siconos-now.scm && \
    guix time-machine  -C siconos-now.scm -- describe -f channels 2>/dev/null > siconos-$(date --iso-8601).scm
#+end_src

* Examples

** The reproductible Bouncing ball with reference check

#+name: bouncing-ball-computation
#+begin_src sh :dir /tmp :compile :file bouncing-ball-computation :results output silent
  wget -q -N https://raw.githubusercontent.com/siconos/guix-siconos/channels/siconos-2021-05-05.scm && \
    guix time-machine -C siconos-2021-05-05.scm -- \
         environment \
         --pure --ad-hoc gcc-toolchain cmake make coreutils grep dash \
         siconos@4.3 siconos-tutorials -- \
         dash -c '
  cp ${GUIX_ENVIRONMENT}/share/siconos/siconos-tutorials/examples/mechanics/BouncingBall/BouncingBallTS.ref .
  siconos ${GUIX_ENVIRONMENT}/share/siconos/siconos-tutorials/examples/mechanics/BouncingBall/BouncingBallTS.cpp'
#+end_src

** A reproductible experiment of a cube falling on the ground

*** Computation

#+name: cube-computation
#+begin_src sh :dir /tmp :compile :results output silent
  wget -N https://raw.githubusercontent.com/siconos/guix-siconos/channels/siconos-2021-05-05.scm && \
    guix time-machine -C siconos-2021-05-05.scm -- \
         environment --pure --ad-hoc siconos siconos-tutorials dash -- \
         dash -c 'siconos ${GUIX_ENVIRONMENT}/share/siconos/siconos-tutorials/examples/mechanics/GeometricPrimitives/cube.py'
#+end_src

*** Visualization

#+name: cube-visualization
#+begin_src sh :dir /tmp :compile :results output silent
  wget -N https://raw.githubusercontent.com/siconos/guix-siconos/channels/siconos-2021-05-05.scm && \
    guix time-machine -C siconos-2021-05-05.scm -- \
         environment  --pure --ad-hoc python-vtk@8.2.0 siconos -- \
         siconos_vview cube.hdf5
#+end_src
y
** Open Cascade contactors

*** Computation

A simple example of a double pendulum with Open Cascade
contactors. The computation is done with a previous version of Siconos
(=siconos@4.2=) and a specific commit on siconos-tutorials:

#+name: occ_double_pendulum
#+begin_src sh :dir /tmp :compile :results output silent
  wget -N https://raw.githubusercontent.com/siconos/guix-siconos/channels/siconos-2021-05-31-2021-05-10.scm && \
    guix time-machine -C siconos-2021-05-31-2021-05-10.scm -- \
         environment --with-git-url=siconos-tutorials=https://github.com/siconos/siconos-tutorials \
         --with-commit=siconos-tutorials=7e1322d1c51224970967e46408b81a84e81b18a8 \
         --pure --ad-hoc siconos@4.2 siconos-tutorials python pythonocc dash -- \
         dash -c 'siconos ${GUIX_ENVIRONMENT}/share/siconos/siconos-tutorials/examples/mechanics/MultiBodySystems/OCC_Examples/occ_double_pendulum.py'
#+end_src

*** Visualization

#+name: double_pendulum_visualization
#+begin_src sh :dir /tmp :compile :results output silent
  wget -N https://raw.githubusercontent.com/siconos/guix-siconos/channels/siconos-2021-05-05.scm && \
    guix time-machine -C siconos-2021-05-05.scm -- \
         environment --pure --ad-hoc pythonocc python-vtk@8.2.0 siconos -- \
         siconos_vview occ_double_pendulum.hdf5
#+end_src


* Siconos compilation with a guix environment

The =siconos= package is placed *before* =--ad-hoc= option in order to
provide the necessary =inputs= packages:

#+name: siconos-build
#+begin_src sh :dir /tmp :compile :results output silent
  git clone --depth 1 https://github.com/siconos/siconos &&
  wget -N https://raw.githubusercontent.com/siconos/guix-siconos/channels/siconos-2021-05-05.scm && \
    guix time-machine -C siconos-2021-05-05.scm -- \
       environment siconos --pure --ad-hoc dash -- \
       dash -c 'mkdir -p siconos-build && cd siconos-build && cmake ../siconos && make -j8'
#+end_src
